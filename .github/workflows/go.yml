# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]


permissions:
    contents: read
    pull-requests: read
    checks: write

jobs:

  build:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.1'
        cache: true

    - name: Build
      run: |
        make caddy

    - name: Test
      run: make test-go

  integration-test:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.1'
        cache: true

    - name: Install benchstat
      run: go install golang.org/x/perf/cmd/benchstat@latest

    - name: Build Caddy
      run: make caddy

    - name: Trust Caddy CA
      run: |
        # Start caddy temporarily to generate certificates
        ./caddy start --config <(echo '{ "admin": { "listen": "localhost:2019" } }')
        sleep 2
        # Trust the CA
        #sudo ./caddy trust
        ./caddy trust
        # Stop caddy
        ./caddy stop
        sleep 1

    - name: Run Integration Tests
      run: |
        # Pin to 12 CPUs for consistent benchmark results
        taskset -c 0-11 go test -v -timeout 10m -tags=integration ./integration-tests/...

    - name: Download main branch integration benchmark results
      id: cache-integration-main
      if: github.event_name == 'pull_request'
      uses: actions/cache/restore@v4
      with:
        path: main-integration-benchmark-results.txt
        key: integration-benchmark-main-${{ runner.os }}-dummy
        restore-keys: |
          integration-benchmark-main-${{ runner.os }}-

    - name: Compare integration benchmarks
      if: github.event_name == 'pull_request'
      run: |
        if [ -f main-integration-benchmark-results.txt ] && [ -f integration-benchmark-results.txt ]; then
          echo "## Integration Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Comparing current branch against main:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          benchstat main-integration-benchmark-results.txt integration-benchmark-results.txt >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY
        elif [ -f integration-benchmark-results.txt ]; then
          echo "## Integration Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "No main branch baseline available for comparison." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat integration-benchmark-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
        fi

    - name: Prepare main branch integration benchmark results for caching
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        if [ -f integration-benchmark-results.txt ]; then
          cp integration-benchmark-results.txt main-integration-benchmark-results.txt
        fi

    - name: Save main branch integration benchmark results
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/cache/save@v4
      with:
        path: main-integration-benchmark-results.txt
        key: integration-benchmark-main-${{ runner.os }}-${{ github.sha }}

  lint:
    runs-on: self-hosted
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.1'
        cache: true

    - name: Build
      run: |
        make caddy

    - name: golangci-lint
      uses: golangci/golangci-lint-action@v9
      with:
        version: latest
        only-new-issues: false
        args: --tests=false

  benchmark:
    runs-on: self-hosted
    permissions:
      contents: read
      pull-requests: write
    steps:
    - uses: actions/checkout@v6

    - name: Set up Go
      uses: actions/setup-go@v6
      with:
        go-version: '1.25.1'
        cache: true

    - name: Install benchstat
      run: go install golang.org/x/perf/cmd/benchstat@latest

    - name: Run benchmarks
      run: |
        # Pin to 12 CPUs for consistent results across different machines
        # Only capture stdout (benchmark output), let stderr go to console
        taskset -c 0-11 go test -bench=. -benchmem -count=6 -timeout 10m ./atlas/faster/... | tee benchmark-results.txt

    - name: Download main branch benchmark results
      id: cache-main
      if: github.event_name == 'pull_request'
      uses: actions/cache/restore@v4
      with:
        path: main-benchmark-results.txt
        key: benchmark-main-${{ runner.os }}-dummy
        restore-keys: |
          benchmark-main-${{ runner.os }}-

    - name: Compare benchmarks
      if: github.event_name == 'pull_request' && steps.cache-main.outputs.cache-hit != ''
      run: |
        echo "## Benchmark Comparison" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Comparing current branch against main:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        benchstat main-benchmark-results.txt benchmark-results.txt >> $GITHUB_STEP_SUMMARY 2>&1 || true
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Show benchmark results (no comparison available)
      if: github.event_name == 'pull_request' && steps.cache-main.outputs.cache-hit == ''
      run: |
        echo "## Benchmark Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "No main branch baseline available for comparison." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat benchmark-results.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Show benchmark results (main branch)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: |
        echo "## Benchmark Results (Main Branch)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        cat benchmark-results.txt >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

    - name: Prepare main branch benchmark results for caching
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      run: cp benchmark-results.txt main-benchmark-results.txt

    - name: Save main branch benchmark results
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: actions/cache/save@v4
      with:
        path: main-benchmark-results.txt
        key: benchmark-main-${{ runner.os }}-${{ github.sha }}
